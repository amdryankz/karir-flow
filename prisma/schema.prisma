// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client"
  output          = "../generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pg_trgm]
}

model User {
  id                String             @id
  name              String
  email             String
  emailVerified     Boolean            @default(false)
  image             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  sessions          Session[]
  accounts          Account[]
  pdfDocuments      PdfDocument[]
  questionSets      QuestionSet[]
  interviewSessions InterviewSession[]
  offerLetters  OfferLetter[]

  @@unique([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model PdfDocument {
  id            String         @id @default(uuid())
  userId        String
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  fileName      String
  pdfUrl        String
  pageCount     Int
  uploadDate    DateTime       @default(now())
  extractedText ExtractedText?

  @@map("pdfDocument")
}

model ExtractedText {
  id         String      @id @default(uuid())
  documentId String      @unique
  document   PdfDocument @relation(fields: [documentId], references: [id])
  content    String

  @@index([content(ops: raw("gin_trgm_ops"))], type: Gin)
  @@map("extractedText")
}

model QuestionSet {
  id                String             @id @default(uuid())
  userId            String
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  description       String
  createdAt         DateTime           @default(now())
  questions         Question[]
  interviewSessions InterviewSession[]

  @@map("questionSet")
}

model Question {
  id            String      @id @default(uuid())
  questionSetId String
  questionSet   QuestionSet @relation(fields: [questionSetId], references: [id], onDelete: Cascade)
  text          String
  voiceUrl      String?
  order         Int
  answers       Answer[]

  @@map("question")
}

enum SpeechPace {
  TOO_FAST
  NORMAL
  TOO_SLOW
}

enum ConfidenceLevel {
  HIGH
  MEDIUM
  LOW
}

model InterviewSession {
  id            String             @id @default(uuid())
  title         String
  startedAt     DateTime           @default(now())
  finishedAt    DateTime?
  totalScore    Int?
  userId        String
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionSetId String
  questionSet   QuestionSet        @relation(fields: [questionSetId], references: [id], onDelete: Cascade)
  answers       Answer[]
  parentId      String?
  parent        InterviewSession?  @relation("sessionHistory", fields: [parentId], references: [id], onDelete: SetNull)
  children      InterviewSession[] @relation("sessionHistory")

  @@map("interviewSession")
}

model Answer {
  id                 String           @id @default(uuid())
  transcription      String
  audioUrl           String?
  feedbackContent    String?
  feedbackTone       String?
  score              Int
  speechPace         SpeechPace
  confidentLevel     ConfidenceLevel
  tips               String?
  answeredAt         DateTime         @default(now())
  interviewSessionId String
  session            InterviewSession @relation(fields: [interviewSessionId], references: [id], onDelete: Cascade)
  questionId         String
  question           Question         @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("answer")
}

model OfferLetter {
  id            String          @id @default(uuid())
  userId        String
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  title         String
  fileUrl       String
  status        String // uploaded, analyzed, failed
  createdAt     DateTime        @default(now())
  analysis      OfferAnalysis?
  redFlags      RedFlag[]

  @@map("offerLetter")
}

model OfferAnalysis {
  id                   String      @id @default(uuid())
  offerLetterId        String      @unique
  offerLetter          OfferLetter @relation(fields: [offerLetterId], references: [id], onDelete: Cascade)
  
  baseSalaryAmount     String?
  bonusPolicy          String?
  equityValue          String?
  allowances           String?
  totalCompensation    String?

  jobTitle             String?
  employmentType       String?
  workingHours         String?
  workLocation         String?
  startDate            String?
  probationTerms       String?
  leavePolicy          String?

  competitivenessScore Int?
  competitivenessText  String?

  clarityScore         Int?
  legalComplexity      String?
  employerFavorability String?

  negotiationItems     String?
  negotiationPhrases   String?

  missingItems         String?

  analyzedAt           DateTime    @default(now())

  @@map("offerAnalysis")
}

model RedFlag {
  id            String      @id @default(uuid())
  offerLetterId String
  offerLetter   OfferLetter @relation(fields: [offerLetterId], references: [id], onDelete: Cascade)
  type          String
  description   String
  severity      String // low, medium, high

  @@map("redFlag")
}
